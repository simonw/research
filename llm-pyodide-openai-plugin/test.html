<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>LLM Pyodide OpenAI Plugin Test</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        #output {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 100px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>LLM Pyodide OpenAI Plugin Test</h1>

    <div id="status" class="status">Initializing...</div>

    <div>
        <h3>Test Steps:</h3>
        <button id="btn-init" onclick="initTest()">1. Initialize Pyodide & Load Packages</button>
        <button id="btn-install" onclick="installLLM()" disabled>2. Install LLM Package</button>
        <button id="btn-load-plugin" onclick="loadPlugin()" disabled>3. Load Pyodide Plugin</button>
        <button id="btn-test" onclick="testPlugin()" disabled>4. Test OpenAI Call (will fail auth)</button>
    </div>

    <div>
        <h3>API Key (optional - test will fail auth without it):</h3>
        <input type="password" id="api-key" placeholder="sk-...">
    </div>

    <h3>Output:</h3>
    <div id="output">Click buttons above to run tests...</div>

    <script>
        let pyodide = null;
        let pluginCode = null;

        function setStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isError ? 'error' : '');
        }

        function addOutput(text) {
            const output = document.getElementById('output');
            output.textContent += text + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        async function initTest() {
            try {
                clearOutput();
                setStatus('Loading Pyodide...');
                addOutput('Loading Pyodide...');

                pyodide = await loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/'
                });

                addOutput('✓ Pyodide loaded');
                setStatus('Pyodide loaded successfully');

                document.getElementById('btn-install').disabled = false;
            } catch (e) {
                addOutput('✗ Error: ' + e.message);
                setStatus('Error loading Pyodide', true);
                console.error(e);
            }
        }

        async function installLLM() {
            try {
                setStatus('Installing LLM and dependencies...');
                addOutput('\nInstalling LLM via micropip...');

                // Load micropip
                await pyodide.loadPackage('micropip');
                const micropip = pyodide.pyimport('micropip');

                // Install LLM
                addOutput('Installing llm package...');
                await micropip.install('llm');
                addOutput('✓ LLM installed');

                // Test import
                addOutput('\nTesting LLM import...');
                await pyodide.runPythonAsync(`
import llm
print(f"LLM version: {llm.__version__ if hasattr(llm, '__version__') else 'unknown'}")
print("LLM imported successfully!")
                `);

                setStatus('LLM installed successfully');
                document.getElementById('btn-load-plugin').disabled = false;

            } catch (e) {
                addOutput('✗ Error: ' + e.message);
                setStatus('Error installing LLM', true);
                console.error(e);
            }
        }

        async function loadPlugin() {
            try {
                setStatus('Loading pyodide plugin...');
                addOutput('\nLoading pyodide OpenAI plugin...');

                // Fetch the plugin code
                const response = await fetch('llm_pyodide_openai.py');
                pluginCode = await response.text();

                addOutput('✓ Plugin code fetched');

                // Register the plugin
                addOutput('\nRegistering plugin with LLM...');

                // Write plugin to virtual filesystem
                pyodide.FS.writeFile('/llm_pyodide_openai.py', pluginCode);

                await pyodide.runPythonAsync(`
import llm
from llm.plugins import pm

# Import the plugin module
import llm_pyodide_openai

# Register it
pm.register(llm_pyodide_openai, 'llm_pyodide_openai')

# Load plugins to activate
llm.load_plugins()

# List available models
print("Available models:")
for model_alias in llm.get_models_with_aliases():
    print(f"  - {model_alias.model.model_id}")
                `);

                setStatus('Plugin loaded successfully');
                document.getElementById('btn-test').disabled = false;

            } catch (e) {
                addOutput('✗ Error: ' + e.message);
                setStatus('Error loading plugin', true);
                console.error(e);
            }
        }

        async function testPlugin() {
            try {
                const apiKey = document.getElementById('api-key').value;

                setStatus('Testing OpenAI API call...');
                addOutput('\nTesting OpenAI API call...');

                if (!apiKey) {
                    addOutput('⚠ No API key provided - this will fail with auth error');
                    addOutput('  (This is expected and demonstrates CORS works)');
                }

                // Set API key if provided
                if (apiKey) {
                    pyodide.globals.set('api_key_value', apiKey);
                    await pyodide.runPythonAsync(`
import os
os.environ['OPENAI_API_KEY'] = api_key_value
                    `);
                }

                // Try to use the model
                const result = await pyodide.runPythonAsync(`
import llm

try:
    # Get the pyodide model
    model = llm.get_model("pyodide-gpt-4o-mini")
    print(f"Using model: {model}")

    # Try to make a call
    prompt = "Say 'Hello from pyodide!' in one sentence."
    print(f"Sending prompt: {prompt}")

    response = model.prompt(prompt)
    result = response.text()

    print(f"Response: {result}")
    "SUCCESS: " + result

except Exception as e:
    error_msg = str(e)
    print(f"Error: {error_msg}")
    "ERROR: " + error_msg
                `);

                addOutput('\nResult: ' + result);

                if (result.startsWith('SUCCESS:')) {
                    setStatus('✓ API call successful!', false);
                    addOutput('\n✓ Plugin is working correctly!');
                } else if (result.includes('401') || result.includes('Unauthorized') || result.includes('Incorrect API key')) {
                    setStatus('Got expected auth error (proves CORS works)');
                    addOutput('\n✓ Got expected authentication error');
                    addOutput('  This proves the fetch API is working correctly!');
                    addOutput('  Provide a valid API key to test actual completion.');
                } else {
                    setStatus('Unexpected error', true);
                }

            } catch (e) {
                addOutput('✗ Error: ' + e.message);
                setStatus('Error testing plugin', true);
                console.error(e);
            }
        }

        // Enable first button on load
        window.onload = function() {
            document.getElementById('btn-init').disabled = false;
            setStatus('Ready to start');
        };
    </script>
</body>
</html>
